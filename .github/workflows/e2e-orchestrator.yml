name: e2e-orchestrator

"on":
  workflow_dispatch:

permissions:
  actions: read
  contents: write
  pull-requests: write

jobs:
  orchestrate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: E2Eライフサイクルを実行
        env:
          GH_TOKEN: ${{ github.token }}
          REPOSITORY: ${{ github.repository }}
          STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        shell: bash
        run: |
          set -euo pipefail

          BASE_URL="https://${STORAGE_ACCOUNT}.z11.web.core.windows.net"
          TEST_BRANCH="e2e-orch-${RUN_ID}-${RUN_ATTEMPT}"
          RUN_TAG="e2e-${RUN_ID}-${RUN_ATTEMPT}"

          PR_NUMBER=""
          PR_HEAD_SHA=""
          MAIN_PUSH_DONE=false
          BRANCH_PUSH_DONE=false
          PR_CREATED=false
          PR_CLOSED=false

          log() {
            printf '[orchestrator] %s\n' "$*"
          }

          now_utc() {
            date -u '+%Y-%m-%dT%H:%M:%SZ'
          }

          gh_json() {
            local method="$1"
            local path="$2"
            shift 2
            gh api --method "$method" "$path" "$@"
          }

          wait_deploy_workflow() {
            local event="$1"
            local head_sha="$2"
            local not_before="$3"
            local label="$4"

            local runs_json run_id status conclusion html_url attempt

            for (( attempt = 1; attempt <= 120; attempt++ )); do
              runs_json="$(
                gh api \
                  "/repos/${REPOSITORY}/actions/workflows/deploy.yml/runs?event=${event}&per_page=50"
              )"

              run_id="$(
                jq -r \
                  --arg head_sha "$head_sha" \
                  --arg not_before "$not_before" \
                  '
                    .workflow_runs
                    | map(select(.head_sha == $head_sha and .created_at >= $not_before))
                    | sort_by(.created_at)
                    | (last // empty)
                    | .id // empty
                  ' \
                  <<<"$runs_json"
              )"

              if [[ -z "$run_id" ]]; then
                log "${label}: deploy.yml 実行待機中 (${attempt}/120)"
                sleep 5
                continue
              fi

              status="$(
                jq -r \
                  --argjson run_id "$run_id" \
                  '.workflow_runs[] | select(.id == $run_id) | .status' \
                  <<<"$runs_json"
              )"
              conclusion="$(
                jq -r \
                  --argjson run_id "$run_id" \
                  '.workflow_runs[] | select(.id == $run_id) | (.conclusion // "")' \
                  <<<"$runs_json"
              )"
              html_url="$(
                jq -r \
                  --argjson run_id "$run_id" \
                  '.workflow_runs[] | select(.id == $run_id) | .html_url' \
                  <<<"$runs_json"
              )"

              if [[ "$status" != "completed" ]]; then
                log "${label}: run_id=${run_id} status=${status} 完了待機中"
                sleep 5
                continue
              fi

              if [[ "$conclusion" != "success" ]]; then
                log "${label}: deploy.yml が失敗しました (run_id=${run_id}, conclusion=${conclusion})"
                log "${label}: ${html_url}"
                return 1
              fi

              log "${label}: deploy.yml 成功 (run_id=${run_id})"
              return 0
            done

            log "${label}: deploy.yml 完了待機がタイムアウトしました"
            return 1
          }

          close_pr_if_needed() {
            if [[ "$PR_CREATED" != true || "$PR_CLOSED" == true || -z "$PR_NUMBER" ]]; then
              return 0
            fi

            log "後片付け: PR #${PR_NUMBER} をクローズ"
            gh_json PATCH "/repos/${REPOSITORY}/pulls/${PR_NUMBER}" -f state=closed >/dev/null
            PR_CLOSED=true
          }

          delete_branch_if_needed() {
            if [[ "$BRANCH_PUSH_DONE" != true ]]; then
              return 0
            fi

            log "後片付け: ブランチ ${TEST_BRANCH} を削除"
            if ! gh_json DELETE "/repos/${REPOSITORY}/git/refs/heads/${TEST_BRANCH}" >/dev/null 2>&1; then
              log "後片付け: ブランチ削除はスキップ（既に削除済みの可能性）"
            fi
          }

          cleanup_resources() {
            local cleanup_failed=0

            close_pr_if_needed || cleanup_failed=1
            delete_branch_if_needed || cleanup_failed=1

            return "$cleanup_failed"
          }

          run_scenario() {
            local marker_ts main_sha pr_created_at pr_updated_at pr_closed_at
            local main_marker pr_open_marker pr_updated_marker
            local pr_title pr_body pr_url

            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

            git checkout main
            git pull --ff-only origin main

            main_marker="MAIN-${RUN_TAG}"
            marker_ts="$(now_utc)"
            printf '\n<!-- %s -->\n' "$main_marker" >> docs/index.html
            git add docs/index.html
            git commit -m "test: E2Eオーケストレータのmain更新 ${RUN_TAG}"
            git push origin main
            MAIN_PUSH_DONE=true
            main_sha="$(git rev-parse HEAD)"

            wait_deploy_workflow "push" "$main_sha" "$marker_ts" "main push"
            ./e2e/verify.sh \
              "${BASE_URL}/main/" \
              200 \
              --require-trailing-slash \
              --contains "$main_marker" \
              --retries 20 \
              --interval 5

            git checkout -b "$TEST_BRANCH"
            pr_open_marker="PR-OPEN-${RUN_TAG}"
            cat > docs/index.html <<EOF
          <!doctype html>
          <html lang="ja">
          <head>
            <meta charset="utf-8">
            <title>${pr_open_marker}</title>
          </head>
          <body>
            <h1>${pr_open_marker}</h1>
            <p>stage=open</p>
          </body>
          </html>
          EOF
            printf '%s\n' "obsolete-${RUN_TAG}" > docs/obsolete.txt
            git add docs/index.html docs/obsolete.txt
            git commit -m "test: E2EオーケストレータのPR作成 ${RUN_TAG}"
            git push -u origin "$TEST_BRANCH"
            BRANCH_PUSH_DONE=true
            PR_HEAD_SHA="$(git rev-parse HEAD)"

            pr_title="E2E Orchestrator ${RUN_TAG}"
            pr_body="自動E2E検証用PR（${RUN_TAG}）"
            pr_created_at="$(now_utc)"
            pr_url="$(
              gh_json POST "/repos/${REPOSITORY}/pulls" \
                -f title="$pr_title" \
                -f head="$TEST_BRANCH" \
                -f base=main \
                -f body="$pr_body"
            )"
            PR_NUMBER="$(jq -r '.number' <<<"$pr_url")"
            PR_CREATED=true

            wait_deploy_workflow "pull_request" "$PR_HEAD_SHA" "$pr_created_at" "PR open"
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/" \
              200 \
              --require-trailing-slash \
              --contains "$pr_open_marker" \
              --retries 20 \
              --interval 5
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/obsolete.txt" \
              200 \
              --contains "obsolete-${RUN_TAG}" \
              --retries 20 \
              --interval 5

            pr_updated_marker="PR-UPDATED-${RUN_TAG}"
            cat > docs/index.html <<EOF
          <!doctype html>
          <html lang="ja">
          <head>
            <meta charset="utf-8">
            <title>${pr_updated_marker}</title>
          </head>
          <body>
            <h1>${pr_updated_marker}</h1>
            <p>stage=updated</p>
          </body>
          </html>
          EOF
            printf '%s\n' "fresh-${RUN_TAG}" > docs/fresh.txt
            git add docs/index.html docs/fresh.txt
            git rm -f docs/obsolete.txt
            git commit -m "test: E2EオーケストレータのPR更新 ${RUN_TAG}"
            pr_updated_at="$(now_utc)"
            git push origin "$TEST_BRANCH"
            PR_HEAD_SHA="$(git rev-parse HEAD)"

            wait_deploy_workflow "pull_request" "$PR_HEAD_SHA" "$pr_updated_at" "PR update"
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/" \
              200 \
              --require-trailing-slash \
              --contains "$pr_updated_marker" \
              --retries 20 \
              --interval 5
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/fresh.txt" \
              200 \
              --contains "fresh-${RUN_TAG}" \
              --retries 20 \
              --interval 5
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/obsolete.txt" \
              404 \
              --retries 20 \
              --interval 5

            pr_closed_at="$(now_utc)"
            gh_json PATCH "/repos/${REPOSITORY}/pulls/${PR_NUMBER}" -f state=closed >/dev/null
            PR_CLOSED=true

            wait_deploy_workflow "pull_request" "$PR_HEAD_SHA" "$pr_closed_at" "PR close"
            ./e2e/verify.sh \
              "${BASE_URL}/pr-${PR_NUMBER}/" \
              404 \
              --require-trailing-slash \
              --retries 20 \
              --interval 5

            delete_branch_if_needed
          }

          scenario_status=0
          cleanup_status=0

          run_scenario || scenario_status=$?
          if [[ "$scenario_status" -ne 0 ]]; then
            log "シナリオ失敗のため後片付けを実行します"
          fi

          cleanup_resources || cleanup_status=$?
          if [[ "$cleanup_status" -ne 0 ]]; then
            log "後片付けに失敗しました"
          fi

          if [[ "$scenario_status" -ne 0 ]]; then
            exit "$scenario_status"
          fi
          if [[ "$cleanup_status" -ne 0 ]]; then
            exit "$cleanup_status"
          fi
