name: deploy

"on":
  push:
    branches:
      - main
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed

permissions:
  contents: read
  id-token: write
  issues: write
  pull-requests: write

jobs:
  deploy:
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.ref_name }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure にログイン
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: プレフィックスを決定
        id: target
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            echo "prefix=pr-${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "prefix=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          fi

      - name: 静的Webサイトのエンドポイントを取得
        id: website
        shell: bash
        env:
          AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
        run: |
          set -euo pipefail
          if [[ -z "${AZURE_RESOURCE_GROUP}" ]]; then
            echo "AZURE_RESOURCE_GROUP variable が未設定です" >&2
            exit 1
          fi

          endpoint="$(
            az storage account show \
              --resource-group "${AZURE_RESOURCE_GROUP}" \
              --name "${{ secrets.AZURE_STORAGE_ACCOUNT }}" \
              --query primaryEndpoints.web \
              --output tsv
          )"
          endpoint="${endpoint%/}"

          if [[ -z "${endpoint}" ]]; then
            echo "静的Webサイトのエンドポイント取得に失敗しました" >&2
            exit 1
          fi

          echo "endpoint=${endpoint}" >> "$GITHUB_OUTPUT"

      - name: デプロイ
        id: deploy
        uses: nuitsjp/azure-blob-storage-site-deploy@main
        with:
          storage_account: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          source_dir: docs
          target_prefix: ${{ steps.target.outputs.prefix }}
          static_website_endpoint: ${{ steps.website.outputs.endpoint }}
          action: deploy

      - name: Workflow Summary にアクセスURLを出力
        if: ${{ success() && steps.deploy.outputs.site_url != '' }}
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "## 配置先URL"
            echo
            echo "- event: \`${GITHUB_EVENT_NAME}\`"
            echo "- prefix: \`${{ steps.target.outputs.prefix }}\`"
            if [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
              echo "- PR: #${{ github.event.pull_request.number }}"
            fi
            echo "- URL: ${{ steps.deploy.outputs.site_url }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: PRコメントにステージングURLを投稿
        if: ${{ success() && github.event_name == 'pull_request' && steps.deploy.outputs.site_url != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          pr_number="${{ github.event.pull_request.number }}"
          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          comment_body="$(
            printf '%s\n\n- ステージングURL: %s\n- Workflow Run: %s\n' \
              'デプロイが完了しました。' \
              '${{ steps.deploy.outputs.site_url }}' \
              "${run_url}"
          )"

          gh api \
            "repos/${GITHUB_REPOSITORY}/issues/${pr_number}/comments" \
            --method POST \
            --raw-field "body=${comment_body}" >/dev/null

  cleanup:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true

    steps:
      - name: Azure にログイン
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: クリーンアップ
        uses: nuitsjp/azure-blob-storage-site-deploy@main
        with:
          storage_account: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          target_prefix: pr-${{ github.event.pull_request.number }}
          action: cleanup
